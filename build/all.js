"use strict";function isEmpty(t){return null==t||void 0==t||""===t}var siteUrl="json/",isIE="Microsoft Internet Explorer"==navigator.appName,o2oApp=angular.module("o2oApp",["ngRoute","o2oServices","controllers","directives"]);o2oApp.config(["$routeProvider","$locationProvider","$httpProvider",function(t,e,r){t.when("/products/list/:categoryId/:page",{templateUrl:"partials/products.html",controller:"ProductsCtrl"}).when("/products/:id",{templateUrl:"partials/product.html",controller:"ProductCtrl"}).when("/shop",{templateUrl:"partials/shop.html",controller:"ShopCtrl"}).when("/orders/detail/:id",{templateUrl:"partials/order.html",controller:"OrderCtrl"}).when("/orders/statistic1",{templateUrl:"partials/orderStatistic.html",controller:"OrderStatisticCtrl"}).when("/orders/statistic2",{templateUrl:"partials/orderStatistic2.html",controller:"OrderStatistic2Ctrl"}).when("/orders/list/:page",{templateUrl:"partials/orders.html",controller:"OrdersCtrl"}).otherwise({redirectTo:"/shop"}),e.html5Mode(!1),r.interceptors.push("ErrorInterceptors")}]).run(["$rootScope","o2oSvc",function(t,e){setTimeout(function(){$("#loading").addClass("loadingHide")},500),t.apiURL=siteUrl,window.rootScope=t,t.userName=store.un(),window.currentTime=Date.now(),e.category({},function(e){t.selectShopCats=e}),t.selectCats=[{id:1,name:"蔬菜"},{id:2,name:"水果"},{id:3,name:"肉类"},{id:4,name:"水产"}]}]),function(){function t(t,e){e=e||100;for(var r=[],o=0;o<t;o++)r.push(parseInt(Math.random()*e));return r}function e(t,e){var r=new Date,o=r.getTime()-e*t,a=[];if(12==t){for(var n=0;n<12;n++)a.unshift(r.getFullYear()+"."+(r.getMonth()+1)),r.setDate(-1);return a}for(var n=0;n<t;n++)r.setTime(o+=e),a.push(r.getMonth()+1+"."+r.getDate());return a}function r(t,e){$("#chartContainer").highcharts({title:{text:"",x:-20},xAxis:{categories:t,minTickInterval:Math.ceil(t.length/20)},yAxis:{min:0,title:{text:""},plotLines:[]},series:e}),$("#chartContainer text").last().hide()}function o(t,e){$("#chartContainer").highcharts({chart:{type:"column"},title:{text:""},xAxis:{categories:t,minTickInterval:Math.ceil(t.length/20)},yAxis:{min:0,title:{text:""},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"white"}}},series:e}),$("#chartContainer text").last().hide()}var a=angular.module("controllers",[]);a.controller("ProductsCtrl",["$scope","$location","o2oSvc","$route","$routeParams","$timeout",function(t,e,r,o,a,n){t.categoryId=a.categoryId,t.checkAll=!1;var i=a.page-0,s=10;i<1&&(i=1),i>s&&(i=s),r.products({},function(e){if(t.products=e,t.categoryId>0)for(var r=0;r<e.length;r++)e[r].categoryId=t.categoryId;n(function(){t.pageCtrl.setPages(i,s)},300)}),t.delProduct=function(e){confirm("确定要删除该商品吗？")&&t.products.splice(e,1)},t.delProducts=function(){for(var e=[],r=$(".table input[name='ids']:checked"),o=0;o<r.length;o++)e.push(r.eq(o).val());if(0==e.length)return void alert("请选择商品！");if(confirm("确定要删除商品吗？"))for(var o=e.length-1;o>=0;--o)t.products.splice(e[o],1)}}]),a.controller("ShopCtrl",["$scope","o2oSvc",function(t,e){t.showShop=!1,t.$root.userName&&(t.shop=store.shop(),t.shop||e.shop({},function(e){store.shop(t.shop=e)}),t.editShop=function(){t.editData=store.shop(),t.showShop=!0},t.saveShop=function(){if(!(isEmpty(t.editData.name)||isEmpty(t.editData.address)||isEmpty(t.editData.phone)||isEmpty(t.editData.deliveryLimitAmount)||isEmpty(t.editData.deliveryFee)||isEmpty(t.editData.openingStart)||isEmpty(t.editData.openingEnd)||isEmpty(t.editData.payeeName)||isEmpty(t.editData.payeeNo)||isEmpty(t.editData.payeeBank))){if(!intPattern.test(t.editData.deliveryLimitAmount))return void alert("起送金额必须为整数！");if(!intPattern.test(t.editData.deliveryFee))return void alert("配送金额必须为整数！");if(t.editData.openingStart.toTime2()==-1)return void alert("开始营业时间格式错误！");if(t.editData.openingEnd.toTime2()==-1)return void alert("结束营业时间格式错误！");store.shop(t.shop=t.editData),t.showShop=!1}})}]),a.controller("ProductCtrl",["$scope","$location","o2oSvc","$route","$routeParams",function(t,e,r,o,a){t.tab=1,t.images=[],t.params=[],t.images.push({imagePath:"images/6.png"}),t.params.push({}),t.reload=function(){o.reload()},a.id>0?r.products({},function(e){t.product=e[a.id-1]}):t.product={id:0,imgUrl:"images/6.png",shopCategoryId:1,categoryId:1,unit:"斤",onSale:"true"},t.del=function(t,e){t.splice(e,1)},t.isImgEmpty=function(){if(0==t.images.length)return!0;for(var e=0;e<t.images.length;e++)if(!isEmpty(t.images[e].imagePath)||!isEmpty(t.images[e].description))return!1;return!0},t.saveProduct=function(){return isEmpty(t.product.imgUrl)?void alert("请上传商品图片！"):isEmpty(t.product.name)?void alert("请填写商品名称！"):isEmpty(t.product.price)?void alert("请填写商品单价！"):numPattern1.test(t.product.price)?void alert("保存成功！"):void alert("商品单价为整数或1位小数！")},t.saveImages=function(){for(var e=0;e<t.images.length;e++)if(isEmpty(t.images[e].imagePath)&&isEmpty(t.images[e].description))return void alert("图片或图片描述不能为空！");alert("保存成功！")},t.saveParams=function(){for(var e=0;e<t.params.length;e++)if(isEmpty(t.params[e].productKey)||isEmpty(t.params[e].productValue))return void alert("属性不能为空！");alert("保存成功！")}}]),a.controller("OrdersCtrl",["$scope","$location","o2oSvc","$routeParams","$timeout",function(t,e,r,o,a){t.search={orderNo:o.orderNo||"",customerName:o.customerName||"",paymentType:o.paymentType||"",status:o.status||"",beginTime:o.beginTime||"",endTime:o.endTime||""},t.now=t.search.random=Date.now(),t.doSearch=function(){e.path("/orders/list/1").search(t.search)};var n=isNaN(o.page)?1:o.page-0,i=10;n<1&&(n=1),n>10&&(n=10),t.startIndex=(n-1)*i,t.totalCount=100,t.s={};for(var s in t.search)if(!isEmpty(t.search[s])){if("beginTime"==s||"endTime"==s){var c=t.search[s].toTime("endTime"==s);if(0==c){t.search[s]="";continue}$("input[name="+s+"]").val(t.search[s])}t.s[s]=t.search[s]}r.orders({},function(e){if(t.data=e,a(function(){t.pageCtrl.setPages(n,10)},300),t.s.status)for(var r=0;r<10;r++)t.data[r].status=t.s.status}),t.ship=function(e){"AWAIT_SHIPPED"==t.data[e].status?t.data[e].status="SHIPPED":t.data[e].status="CANCELLED"},$("input[name=beginTime],input[name=endTime]").datepicker({format:"yyyy-mm-dd",endDate:"0d",todayHighlight:!0,autoclose:!0})}]),a.controller("OrderCtrl",["$scope","o2oSvc","$routeParams",function(t,e,r){var o=100-r.id;e.orders({},function(a){t.data=a[9-(r.id-1)%10],t.data.orderNo-=o,t.data.orderDate=Date.now()-12e3*o,e.products({},function(e){t.data.items=e.slice(5,9)})})}]),a.controller("OrderStatisticCtrl",["$scope",function(a){function n(){"line"==a.mode?r(i,s):1==s.length?o(i,s):o(i,[{name:s[0].name,data:s[0].data},{name:s[1].name,data:s[1].data}])}a.search={status:""},a.period=0,a.mode="line";var i,s,c=[30,30,30,12],l=[864e5,2592e5,5184e5,0];a.confirm=function(){var r=c[a.period];i=e(r,l[a.period]);var o,d,u=t(r);if(""!=a.search.status)s=[{name:"订单数",data:u}];else{o=t(r),d=[];for(var p=0;p<r;p++)d.push(u[p]+o[p]);s=[{name:"已取消订单数",data:u},{name:"已完成订单数",data:o},{name:"总订单数",data:d}]}n()},a.changeMode=function(t){t!=a.mode&&(a.mode=t,n())},a.confirm()}]),a.controller("OrderStatistic2Ctrl",["$scope",function(a){function n(){"line"==a.mode?r(i,s):1==s.length?o(i,s):o(i,[{name:s[0].name,data:s[0].data},{name:s[1].name,data:s[1].data}])}a.search={payment:""},a.period=0,a.mode="column";var i,s,c=[30,30,30,12],l=[864e5,2592e5,5184e5,0];a.confirm=function(){var r=c[a.period];i=e(r,l[a.period]);var o,d,u=t(r,1e3);if(""!=a.search.payment)s=[{name:"收益",data:u}];else{o=t(r,1e3),d=[];for(var p=0;p<r;p++)d.push(u[p]+o[p]);s=[{name:"在线支付",data:u},{name:"货到付款",data:o},{name:"总收益",data:d}]}n()},a.changeMode=function(t){t!=a.mode&&(a.mode=t,n())},a.confirm()}]),a.controller("LoginFormCtrl",["$scope","$route",function(t,e){t.data={userName:"test",password:"test"},t.submit=function(){return isEmpty(t.data.userName)||isEmpty(t.data.password)?void alert("请填写用户名或密码！"):(document.cookie="un="+(t.$root.userName=t.data.userName),void("#/shop"==location.hash&&e.reload()))}}]),a.controller("TopMenuCtrl",["$scope",function(t){t.logout=function(){document.cookie="un="+(t.$root.userName="")};var e=$("#left-menu");$("#leftMenuIcon").on("click",function(t){t.stopPropagation(),e.addClass("showMenu")}),$(document).on("click",function(){e.removeClass("showMenu")})}]),a.controller("SideMenuCtrl",["$scope","$location",function(t,e){t.location=e}]),a.controller("PageCtrl",["$scope","$location",function(t,e){t.$parent.$parent.pageCtrl=this;var r,o=e.path();t.go=function(a){""==r?e.path(o+a):t.list(a)},t.go2=function(e){if(13==e.keyCode&&!isEmpty(t.goPage)&&intPattern1.test(t.goPage)){var r=t.goPage-0;r>t.totalPages&&(r=t.totalPages),t.go(r)}},this.setPages=function(e,a,n){t.pageIndex=e-0,t.totalPages=a-0,t.goPage="",r=n||"",""==r&&(o=o.substr(0,o.lastIndexOf("/")+1))}}])}(),function(){var t=angular.module("directives",[]);t.directive("myUpload",function(){return{controller:["$scope","$attrs","$element",function(t,e,r){function o(r){if(!imgPattern.test(r.name))return void alert("请选择图片！");var o=new FileReader;o.onload=function(r){t.uploading=!1,t.$apply(e.myUpload+"='"+r.target.result+"'")},o.readAsDataURL(r)}var a=r.find("input[type=file]")[0],n=!1,i=r.find(".drag");t.$watch(e.myUpload,function(e,r){t.uploadImg=e}),t.uploading=!1,t.uploadFile=function(){return n=!1,a.value?a.files?void o(a.files[0]):void alert("不支持当前版本浏览器！"):void alert("请选择图片！")},t.selectFile=function(){n=!0,a.click()},a.onchange=function(){n&&t.uploadFile()},i.on("dragenter",function(t){t.preventDefault(),t.stopPropagation()}).on("dragover",function(t){t.preventDefault(),t.stopPropagation()}).on("drop",function(t){return t.preventDefault(),t.stopPropagation(),t.originalEvent.dataTransfer.files?void o(t.originalEvent.dataTransfer.files[0]):void alert("不支持当前版本浏览器！")})}],templateUrl:"partials/upload.html"}}),t.directive("mySrc",function(){return{controller:["$scope","$attrs","$element",function(t,e,r){r.addClass("fade"),r.on("load",function(){$(this).addClass("fadeIn")}),t.$watch(e.mySrc,function(t,e){t&&(r.removeClass("fadeIn"),e?setTimeout(function(){r.attr("src",t)},200):r.attr("src",t))})}],link:function(t){}}})}();var o2oServices=angular.module("o2oServices",["ngResource"]);o2oServices.factory("o2oSvc",["$resource",function(t){return t("",{},{category:{method:"GET",cache:!1,url:siteUrl+"category.json",isArray:!0},shop:{method:"GET",cache:!1,url:siteUrl+"shop.json",isArray:!1},products:{method:"GET",url:siteUrl+"products.json",cache:!1,isArray:!0},orders:{method:"GET",url:siteUrl+"orders.json",cache:!1,isArray:!0}})}]),o2oServices.factory("ErrorInterceptors",["$q","$location","$timeout",function(t,e,r){return{request:function(t){if(void 0==t.params&&(t.params={}),t.params.cdt=currentTime,t.url.indexOf(siteUrl)!=-1){var e=new Date;t.params.dt=e.getTime()}return t}}}]);var numPattern1=/^\d*(\.\d{1}0*){0,1}$/,intPattern=/^\d+$/,intPattern1=/^[1-9]{1}\d*$/,dateTimePattern=/^\d{4}\-\d{1,2}\-\d{1,2}(\s\d{1,2}:[0-5]{0,1}\d{1}:[0-5]{0,1}\d{1}){0,1}$/,timePattern=/^\d{1,2}:[0-5]{0,1}\d{1}$/,imgPattern=/\.(png|jpeg|jpg|gif|bmp)$/i;String.prototype.toTime=function(t){if(!dateTimePattern.test(this.toString()))return 0;try{var e=new Date;e.setHours(0,0,0,0);var r=this.split(" ");if(void 0!=t&&t&&1==r.length&&(r[1]="23:59:59"),2==r.length){var o=r[1].split(":");if(o[0]-0>23)throw new Exception;e.setHours(o[0],o[1],o[2],0)}return r=r[0].split("-"),e.setFullYear(r[0],r[1]-1,r[2]),e.getTime()}catch(t){}return 0},String.prototype.toTime2=function(){if(!timePattern.test(this.toString()))return-1;try{var t=new Date;t.setTime(0);var e=this.split(":");return e[0]-0>23?-1:(t.setHours(e[0],e[1],0,0),t.getTime())}catch(t){}return-1},String.prototype.ellipsis=function(t){return this.length<=t?this.toString():this.substr(0,t)+"..."},String.prototype.getOrderStatus=function(){var t=this.toString();return"CANCELLED"==t?"已取消":"AWAIT_PAY"==t?"待付款":"SHIPPED"==t?"已发货":"AWAIT_SHIPPED"==t?"待发货":"AWAIT_REFUND"==t?"待退款":"已完成"},String.prototype.getOtherStatus=function(){var t=this.toString();return"ONESELF"==t?"自提":"HOME_DELIVERY"==t?"送货上门":"COD"==t?"货到付款":"ONLINE"==t?"在线支付":"AWAITAUDIT"==t?"待审核":"OPENING"==t?"营业中":"HALFTIME"==t?"休息中":"CLOSED"==t?"关闭":"AUDITFAILED"==t?"审核失败":t},String.prototype.encode=function(){return encodeURIComponent(this)},String.prototype.toTimeByMonth=function(){var t=this.split("-"),e=new Date;return e.setHours(0,0,0,0),e.setFullYear(t[0],t[1]-1,1),e.getTime()},function(){var t=sessionStorage;window.store={shop:function(e){return e?void(t.shop=angular.toJson(e)):t.shop?angular.fromJson(t.shop):null},un:function(){var t=document.cookie;if(!t)return null;var e=t.match(new RegExp("(^|;\\s?)un=(\\w*)"));return e?e[2]:null}}}();